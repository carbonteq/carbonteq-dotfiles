{{ if eq .chezmoi.os "linux" -}}
#!/usr/bin/env bash

# ==============================================================================
#                   DEV & PRODUCTIVITY TOOLS (UBUNTU)
# ==============================================================================

set -Eeuo pipefail
trap 'echo -e "\n‚ùå ERROR: Command failed at line $LINENO"; exit 1' ERR

# ---------- HELPERS ----------
log()  { echo -e "\nüîπ \033[1;34m$1\033[0m"; }
ok()   { echo -e "‚úÖ \033[1;32m$1\033[0m"; }
warn() { echo -e "‚ö†Ô∏è  \033[1;33m$1\033[0m"; }

command_exists() {
  command -v "$1" >/dev/null 2>&1
}

sudo -v || { echo "‚ùå Sudo access required"; exit 1; }

export DEBIAN_FRONTEND=noninteractive

# ==============================================================================
# NODE, PNPM, BUN (via mise)
# ==============================================================================
log "Installing Node LTS, pnpm and bun via mise..."

if ! command_exists mise; then
  curl https://mise.jdx.dev/install.sh | sh
fi

export PATH="$HOME/.local/share/mise/bin:$HOME/.local/share/mise/shims:$PATH"
eval "$(mise activate bash --shims)"

mise use --global node@lts
mise use --global pnpm@latest
mise use --global bun@latest

ok "Node LTS, pnpm and bun installed"

# ==============================================================================
# GOOGLE CLOUD SDK
# ==============================================================================
if ! command_exists gcloud; then
  log "Installing Google Cloud SDK..."
  sudo apt-get install -y apt-transport-https ca-certificates gnupg
  curl -fsSL https://packages.cloud.google.com/apt/doc/apt-key.gpg \
    | sudo gpg --dearmor -o /etc/apt/keyrings/cloud.google.gpg
  echo "deb [signed-by=/etc/apt/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" \
    | sudo tee /etc/apt/sources.list.d/google-cloud-sdk.list >/dev/null
  sudo apt-get update
  sudo apt-get install -y google-cloud-cli
  ok "Google Cloud SDK installed"
else
  echo "‚è≠Ô∏è  gcloud already installed, skipping..."
fi

# ==============================================================================
# DOCKER
# ==============================================================================
if ! command_exists docker; then
  log "Installing Docker..."
  sudo apt-get install -y ca-certificates curl gnupg
  sudo install -m 0755 -d /etc/apt/keyrings
  curl -fsSL https://download.docker.com/linux/ubuntu/gpg \
    | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
  sudo chmod a+r /etc/apt/keyrings/docker.gpg

  echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] \
https://download.docker.com/linux/ubuntu $(. /etc/os-release && echo "$VERSION_CODENAME") stable" \
    | sudo tee /etc/apt/sources.list.d/docker.list >/dev/null

  sudo apt-get update
  sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

  sudo usermod -aG docker "$USER" || true
  ok "Docker installed (logout required for group change)"
else
  echo "‚è≠Ô∏è  Docker already installed, skipping..."
fi

# ==============================================================================
# ATUIN (SHELL HISTORY)
# ==============================================================================
if ! command_exists atuin; then
  log "Installing atuin..."
  curl -fsSL https://raw.githubusercontent.com/atuinsh/atuin/main/install.sh | bash
  ok "atuin installed"
else
  echo "‚è≠Ô∏è  atuin already installed, skipping..."
fi

# ==============================================================================
# ZED EDITOR
# ==============================================================================
if ! command_exists zed; then
  log "Installing Zed editor..."
  curl -fsSL https://zed.dev/install.sh | sh
  ok "Zed installed"
else
  echo "‚è≠Ô∏è  Zed already installed, skipping..."
fi

# ==============================================================================
# ALACRITTY
# ==============================================================================
if ! command_exists alacritty; then
  log "Installing Alacritty..."
  sudo apt-get install -y alacritty
  ok "Alacritty installed"
else
  echo "‚è≠Ô∏è  Alacritty already installed, skipping..."
fi

# ==============================================================================
# GITHUB CLI
# ==============================================================================
if ! command_exists gh; then
  log "Installing GitHub CLI..."
  curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg \
    | sudo dd of=/etc/apt/keyrings/githubcli.gpg
  sudo chmod go+r /etc/apt/keyrings/githubcli.gpg
  echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/githubcli.gpg] \
https://cli.github.com/packages stable main" \
    | sudo tee /etc/apt/sources.list.d/github-cli.list >/dev/null
  sudo apt-get update
  sudo apt-get install -y gh
  ok "GitHub CLI installed"
else
  echo "‚è≠Ô∏è  gh already installed, skipping..."
fi

# ==============================================================================
# NETWORK COMMAND ALIASES
# ==============================================================================
log "Installing network utilities..."
sudo apt-get install -y net-tools dnsutils nmap traceroute
ok "Network tools installed"

# ==============================================================================
# GOOGLE CHROME
# ==============================================================================
if ! command_exists google-chrome; then
  log "Installing Google Chrome..."
  curl -fsSL https://dl.google.com/linux/linux_signing_key.pub \
    | sudo gpg --dearmor -o /etc/apt/keyrings/google-chrome.gpg
  echo "deb [arch=amd64 signed-by=/etc/apt/keyrings/google-chrome.gpg] \
http://dl.google.com/linux/chrome/deb/ stable main" \
    | sudo tee /etc/apt/sources.list.d/google-chrome.list >/dev/null
  sudo apt-get update
  sudo apt-get install -y google-chrome-stable
  ok "Google Chrome installed"
else
  echo "‚è≠Ô∏è  Chrome already installed, skipping..."
fi

# ==============================================================================
# CLOUDFLARE TUNNEL (Binary install ‚Äì noble safe)
# ==============================================================================
if ! command_exists cloudflared; then
  log "Installing Cloudflare Tunnel (cloudflared)..."

  TMP_DIR="$(mktemp -d)"
  ARCH="$(dpkg --print-architecture)"

  case "$ARCH" in
    amd64)  CF_ARCH="amd64" ;;
    arm64)  CF_ARCH="arm64" ;;
    *)      warn "Unsupported architecture: $ARCH"; exit 1 ;;
  esac

  curl -fsSL \
    "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-${CF_ARCH}.deb" \
    -o "$TMP_DIR/cloudflared.deb"

  sudo dpkg -i "$TMP_DIR/cloudflared.deb"
  rm -rf "$TMP_DIR"

  ok "cloudflared installed"
else
  echo "‚è≠Ô∏è  cloudflared already installed, skipping..."
fi

# ==============================================================================
# DESKTOP APPS (.deb PACKAGES ‚Äì ROBUST & SELF-HEALING)
# ==============================================================================
log "Installing .deb based apps..."

# Helper function to check if deb package is installed
is_installed_deb() {
  local pkgname="$1"
  dpkg-query -W -f='${Status}' "$pkgname" 2>/dev/null | grep -q "install ok installed"
}

# Helper function to install deb package (with auto-detect filename)
install_deb_package() {
  local name="$1"
  local zip_url="$2"
  local pkg_pattern="$3"
  local target_dir="/tmp/${name}_install"
  
  mkdir -p "$target_dir"
  cd "$target_dir"
  
  # Skip if already installed
  if is_installed_deb "$name"; then
    echo "‚è≠Ô∏è  $name already installed, skipping..."
    cd /
    rm -rf "$target_dir"
    return
  fi
  
  log "Downloading $name .deb package..."
  
  # Download zip
  if ! wget -q "$zip_url"; then
    warn "Download failed for $name"
    cd /
    rm -rf "$target_dir"
    return
  fi
  
  # Unzip
  if ! unzip -q "${name}-linux-deb-latest.zip"; then
    warn "Unzip failed for $name"
    cd /
    rm -rf "$target_dir"
    return
  fi
  
  # Find and install the .deb (auto-detect version)
  if [ -f "$pkg_pattern" ]; then
    if sudo dpkg -i "$pkg_pattern"; then
      sudo apt-get -f install -y
      ok "$name installed successfully"
    else
      warn "dpkg install failed for $name"
    fi
  else
    warn "No .deb file found matching $pkg_pattern"
  fi
  
  cd /
  rm -rf "$target_dir"
}

# --- Apidog (official .deb method) ---
install_deb_package "apidog" \
  "https://file-assets.apidog.com/download/Apidog-linux-deb-latest.zip" \
  "apidog_*_amd64.deb"


# ==============================================================================
# COMPLETE
# ==============================================================================
echo -e "\nüéâ Dev tools provisioning complete!"
ok "Restart your shell to apply PATH changes"

{{ end -}}
