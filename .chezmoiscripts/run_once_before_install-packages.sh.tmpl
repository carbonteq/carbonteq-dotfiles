{{- if eq .chezmoi.os "linux" -}}
#!/usr/bin/env bash
set -Eeuo pipefail

############################################
# Developer Laptop Bootstrap Script (Linux)
# Safe to re-run | Idempotent | Chezmoi-ready
############################################

# ---------- GLOBALS ----------
export DEBIAN_FRONTEND=noninteractive

# ---------- HELPER FUNCTIONS ----------
log() { echo -e "\nüîπ $1"; }
ok()  { echo -e "‚úÖ $1"; }
warn(){ echo -e "‚ö†Ô∏è  $1"; }

command_exists() { command -v "$1" >/dev/null 2>&1; }
apt_installed()  { dpkg -s "$1" >/dev/null 2>&1; }
snap_installed() { snap list "$1" >/dev/null 2>&1; }

safe_apt_install() {
  local pkgs=("$@")
  local missing=()

  for pkg in "${pkgs[@]}"; do
    apt_installed "$pkg" || missing+=("$pkg")
  done

  if (( ${#missing[@]} > 0 )); then
    log "Installing apt packages: ${missing[*]}"
    sudo apt-get update -qq
    sudo apt-get install -y "${missing[@]}"
  else
    ok "All apt packages already installed"
  fi
}

# ---------- PRE-FLIGHT ----------
log "Starting system provisioning"

sudo -v || { echo "‚ùå Sudo access required"; exit 1; }

# ---------- BASE SYSTEM ----------
safe_apt_install \
  ca-certificates \
  gnupg \
  lsb-release \
  software-properties-common \
  curl \
  wget \
  git \
  unzip \
  build-essential \
  zsh \
  ripgrep \
  fzf \
  jq \
  htop \
  tree \
  tmux \
  python3 \
  python3-pip

# ---------- APT REPOSITORIES ----------
log "Configuring third-party repositories"

## VS Code
if [ ! -f /etc/apt/sources.list.d/vscode.list ]; then
  log "Adding VS Code repository"
  curl -fsSL https://packages.microsoft.com/keys/microsoft.asc \
    | gpg --dearmor \
    | sudo tee /usr/share/keyrings/microsoft.gpg >/dev/null

  echo "deb [arch=amd64 signed-by=/usr/share/keyrings/microsoft.gpg] \
https://packages.microsoft.com/repos/code stable main" \
    | sudo tee /etc/apt/sources.list.d/vscode.list >/dev/null
else
  ok "VS Code repo already exists"
fi

## Google Chrome
# ---------- GOOGLE CHROME ----------
log "Configuring Google Chrome repository"

curl -fsSL https://dl.google.com/linux/linux_signing_key.pub \
  | sudo gpg --dearmor \
  | sudo tee /usr/share/keyrings/google-chrome.gpg >/dev/null

echo "deb [arch=amd64 signed-by=/usr/share/keyrings/google-chrome.gpg] \
http://dl.google.com/linux/chrome/deb/ stable main" \
  | sudo tee /etc/apt/sources.list.d/google-chrome.list >/dev/null

# ---------- SNAP PACKAGES ----------
log "Installing Snap packages"

if command_exists snap; then
  for pkg in mattermost-desktop; do
    if ! snap_installed "$pkg"; then
      sudo snap install "$pkg"
    else
      ok "Snap $pkg already installed"
    fi
  done
else
  warn "Snap not available, skipping snap installs"
fi

# ---------- CURSOR AI ----------
log "Installing Cursor AI"

CURSOR_BIN="$HOME/.local/bin/cursor"

if ! command_exists cursor; then
  mkdir -p "$HOME/.local/bin"
  curl -L https://downloader.cursor.sh/linux/appImage/x64 \
    -o "$HOME/.local/bin/cursor.appimage"
  chmod +x "$HOME/.local/bin/cursor.appimage"
  ln -sf "$HOME/.local/bin/cursor.appimage" "$CURSOR_BIN"
  ok "Cursor AI installed"
else
  ok "Cursor AI already installed"
fi

# ---------- ASDF ----------
log "Installing asdf version manager"

if [ ! -d "$HOME/.asdf" ]; then
  git clone https://github.com/asdf-vm/asdf.git "$HOME/.asdf" --branch v0.14.0
  ok "asdf installed"
else
  ok "asdf already present"
fi

# ---------- FINAL ----------
log "Provisioning complete üéâ"
echo "‚û°Ô∏è  Restart your shell or run: source ~/.zshrc"

{{- end -}}

