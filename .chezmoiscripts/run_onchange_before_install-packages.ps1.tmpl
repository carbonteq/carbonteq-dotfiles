{{ if eq .chezmoi.os "windows" -}}

# ==========================================================
# Windows System Provisioning Script
# ==========================================================
# - Idempotent (safe to re-run)
# - CLI-only (no GUI)
# - Designed for chezmoi automation
# ==========================================================

$ErrorActionPreference = "Stop"

# ----------------------------------------------------------
# Logging helpers
# ----------------------------------------------------------
function Log-Info ($Message) { Write-Host "`n>> [INFO] $Message" -ForegroundColor Cyan }
function Log-Ok   ($Message) { Write-Host ">> [OK]   $Message" -ForegroundColor Green }
function Log-Warn ($Message) { Write-Host ">> [WARN] $Message" -ForegroundColor Yellow }

# ----------------------------------------------------------
# Utility helpers
# ----------------------------------------------------------
function Command-Exists {
    param([Parameter(Mandatory)][string]$Name)

    if (Get-Command $Name -ErrorAction SilentlyContinue) {
        return $true
    }

    # Fallbacks for common user-level installs
    $fallbackPaths = @(
        "$env:USERPROFILE\scoop\shims\$Name.exe",
        "$env:USERPROFILE\.cargo\bin\$Name.exe"
    )

    foreach ($path in $fallbackPaths) {
        if (Test-Path $path) { return $true }
    }

    return $false
}

function Require-Success {
    param([Parameter(Mandatory)][string]$What)

    if ($LASTEXITCODE -ne 0) {
        throw "Failed: $What"
    }
}

# ==========================================================
# Start
# ==========================================================
Log-Info "Starting Windows system provisioning..."

# ----------------------------------------------------------
# Ensure PowerShell can run scripts
# ----------------------------------------------------------
Log-Info "Checking PowerShell execution policy..."

$currentPolicy = Get-ExecutionPolicy -Scope CurrentUser

if ($currentPolicy -eq 'Restricted') {
    Log-Warn "CurrentUser execution policy is Restricted. Changing to RemoteSigned..."
    try {
        Set-ExecutionPolicy -Scope CurrentUser -ExecutionPolicy RemoteSigned -Force
        Log-Ok "Execution policy set to RemoteSigned for CurrentUser."
    } catch {
        Log-Warn "Failed to change execution policy. You may need to run PowerShell as Administrator."
    }
} else {
    Log-Ok "Execution policy is already set to $currentPolicy."
}

# Also allow the current session regardless
Set-ExecutionPolicy -Scope Process -ExecutionPolicy RemoteSigned


# ==========================================================
# 1. Scoop (package manager)
# ==========================================================
if (Command-Exists "scoop") {
    Log-Ok "Scoop already installed."
} else {
    Log-Info "Installing Scoop..."
    Invoke-WebRequest -Uri "https://get.scoop.sh" -UseBasicParsing | Invoke-Expression
    $env:PATH += ";$env:USERPROFILE\scoop\shims"
    Log-Ok "Scoop installed."
}

# ==========================================================
# 2. Base prerequisites (via Scoop)
# ==========================================================
$basePackages = @("git", "msys2", "rustup")

foreach ($pkg in $basePackages) {
    if (Command-Exists $pkg) {
        Log-Ok "$pkg already installed."
    } else {
        Log-Info "Installing $pkg..."
        scoop install $pkg | Out-Null
        Require-Success "$pkg installation"
        Log-Ok "$pkg installed."
    }
}

# Ensure Cargo is on PATH for current session
$cargoBin = "$env:USERPROFILE\.cargo\bin"
if ($env:PATH -notlike "*$cargoBin*") {
    $env:PATH += ";$cargoBin"
}

# ==========================================================
# 3. MSVC Build Tools (required for Rust on Windows)
# ==========================================================
if (Command-Exists "cl") {
    Log-Ok "MSVC Build Tools already installed."
} else {
    Log-Info "Installing MSVC Build Tools (C++ workload)..."
    winget install --id Microsoft.VisualStudio.2022.BuildTools `
        --accept-source-agreements `
        --accept-package-agreements `
        --silent `
        --override "--wait --quiet --add Microsoft.VisualStudio.Workload.VCTools --includeRecommended"
    Log-Ok "MSVC Build Tools installed."
}

# ==========================================================
# 4. Fish shell (via MSYS2)
# ==========================================================
if (Command-Exists "fish") {
    Log-Ok "Fish already installed."
} else {
    $msysBash = "$env:USERPROFILE\scoop\apps\msys2\current\usr\bin\bash.exe"

    if (!(Test-Path $msysBash)) {
        throw "MSYS2 not found. Cannot install Fish."
    }

    Log-Info "Installing Fish via MSYS2..."
    & $msysBash -lc "pacman -Sy --noconfirm --needed fish"
    Require-Success "Fish installation"
    Log-Ok "Fish installed."
}

# ==========================================================
# 5. Nushell
# ==========================================================
if (Command-Exists "nu") {
    Log-Ok "Nushell already installed."
} else {
    Log-Info "Installing Nushell..."
    scoop install nu | Out-Null
    Require-Success "Nushell installation"
    Log-Ok "Nushell installed."
}


# ----------------------------------------------------------
# 6. Rust-based CLI tools (via cargo)
# ----------------------------------------------------------

# Path to rustup installed by Scoop
$rustupPath = "$env:USERPROFILE\scoop\apps\rustup\current\rustup-init.exe"
$cargoBin   = "$env:USERPROFILE\scoop\persist\rustup\.cargo\bin"

if (!(Test-Path $rustupPath)) {
    throw "Rustup executable not found at $rustupPath"
}

if (!(Test-Path $cargoBin)) {
    Log-Info "Cargo bin directory not found yet, it will be created after Rust initialization."
}

# Add Cargo bin to current session PATH
if ($env:PATH -notlike "*$cargoBin*") {
    Log-Info "Adding Cargo bin directory to PATH for this session..."
    $env:PATH += ";$cargoBin"
    Log-Ok "Cargo path updated for current session."
}

# Initialize Rust toolchain if cargo not yet available
if (!(Command-Exists "cargo")) {
    Log-Info "Initializing Rust toolchain..."
    & $rustupPath -y
    Require-Success "Rust toolchain initialization"
    Log-Ok "Rust toolchain installed."
}

# Verify Cargo is now accessible
if (!(Command-Exists "cargo")) {
    throw "Cargo still not found after rustup installation."
}

Log-Ok "Cargo detected, proceeding with Rust CLI tools installation."


# ----------------------------------------------------------
# Install Rust-based CLI tools
# ----------------------------------------------------------
$rustTools = @(
    @{ Name = "bacon";      Cmd = "bacon" },
    @{ Name = "wiki-tui";   Cmd = "wiki-tui" },
    @{ Name = "bob-nvim";   Cmd = "bob" },
    @{ Name = "cargo-information"; Cmd = "cargo-info" }
)

foreach ($tool in $rustTools) {
    if (Command-Exists $tool.Cmd) {
        Log-Ok "$($tool.Name) already installed."
        continue
    }

    Log-Info "Installing $($tool.Name) via cargo..."
    cargo install $tool.Name
    Require-Success "$($tool.Name) installation"

    if (!(Command-Exists $tool.Cmd)) {
        throw "$($tool.Name) installed but binary not found."
    }

    Log-Ok "$($tool.Name) installed."
}


# ==========================================================
# 7. General CLI tools (via Scoop)
# ==========================================================
Log-Info "Installing remaining CLI tools..."

$cliTools = @(
    "ripgrep", "fd", "bat", "eza", "zoxide", "xh","gitui", 
    "dust", "dua", "starship", "yazi", "hyperfine",
    "helix", "fselect", "ncspot", "delta", "rga", "tokei",
    "just", "mask", "mprocs", "presenterm", "kondo",
    "mise", "jq", "fzf"
)

foreach ($tool in $cliTools) {
    if (& scoop list | Select-String "^$tool\s") {
        Log-Ok "$tool already installed."
    } else {
        try {
            Log-Info "Installing $tool..."
            scoop install $tool | Out-Null
            Log-Ok "$tool installed."
        } catch {
            Log-Warn "Failed to install $tool (skipping)"
        }
    }
}

# ==========================================================
# 8. Mise runtime sync
# ==========================================================
if (Command-Exists "mise") {
    Log-Info "Syncing Mise runtimes..."
    mise use --global node@latest python@latest
    Log-Ok "Mise runtimes synced."
}

# ==========================================================
# 9. GUI Applications (via winget)
# ==========================================================
$guiApps = @(
    @{ Name = "Visual Studio Code";      Id = "Microsoft.VisualStudioCode" },
    @{ Name = "Mattermost Desktop App";  Id = "Mattermost.MattermostDesktop" },
    @{ Name = "Cursor";                  Id = "Anysphere.Cursor" }
)

foreach ($app in $guiApps) {
    # Check presence (bestâ€‘effort)
    if (Command-Exists ($app.Name.Split()[0])) {
        Log-Ok "$($app.Name) already installed."
        continue
    }

    Log-Info "Installing $($app.Name)..."
    winget install --id $($app.Id) --exact `
        --accept-source-agreements `
        --accept-package-agreements `
        --silent

    if ($LASTEXITCODE -eq 0) {
        Log-Ok "$($app.Name) installed."
    } elseif ($LASTEXITCODE -eq 1) {
        # Existing package, skip warning
        Log-Ok "$($app.Name) already present (winget skipped install)."
    } else {
        Log-Warn "Failed to install $($app.Name) via winget."
    }
}



# ==========================================================
# Done
# ==========================================================
Log-Ok "Windows provisioning complete ðŸŽ‰"

{{ end -}}
