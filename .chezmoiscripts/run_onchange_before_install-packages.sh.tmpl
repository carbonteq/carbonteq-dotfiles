{{ if (or (eq .chezmoi.os "linux") (eq .chezmoi.os "darwin")) -}}
#!/usr/bin/env bash


# Robust Error Handling
set -Eeuo pipefail
trap 'echo -e "\n‚ùå ERROR: Command failed at line $LINENO. Exiting..."; exit 1' ERR


# ---------- HELPER FUNCTIONS ----------
log()   { echo -e "\nüîπ \033[1;34m$1\033[0m"; }
ok()    { echo -e "‚úÖ \033[1;32m$1\033[0m"; }
warn()  { echo -e "‚ö†Ô∏è  \033[1;33m$1\033[0m"; }

command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# ==============================================================================
#                               MAC OS INSTALLATION
# ==============================================================================
{{ if eq .chezmoi.os "darwin" -}}
log "Starting macOS provisioning..."

# 1. Install Homebrew if missing
if ! command_exists brew; then
    log "Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    eval "$(/opt/homebrew/bin/brew shellenv)"
fi

# 2. Install Desktop Apps (Casks) if missing
log "Checking macOS Desktop Apps..."

MAC_CASKS="
docker-desktop
mattermost
cursor
espanso
visual-studio-code
"

for cask in $MAC_CASKS; do
    case "$cask" in
        docker-desktop)      app_path="/Applications/Docker.app" ;;
        mattermost)          app_path="/Applications/Mattermost.app" ;;
        cursor)              app_path="/Applications/Cursor.app" ;;
        espanso)             app_path="/Applications/Espanso.app" ;;
        visual-studio-code)  app_path="/Applications/Visual Studio Code.app" ;;
        *)                   app_path="" ;;
    esac

    if brew list --cask "$cask" >/dev/null 2>&1; then
        echo "‚è≠Ô∏è  $cask already installed via Homebrew, skipping..."
    elif [ -n "$app_path" ] && [ -d "$app_path" ]; then
        echo "‚è≠Ô∏è  $cask app already exists at $app_path, skipping..."
    else
        log "Installing $cask..."
        brew install --cask "$cask"
    fi
done

# 3. Install CLI Tools (Formulae) if missing
log "Checking macOS CLI tools..."

MAC_TOOLS="fzf jq htop tree tmux git wget coreutils fish nushell ncspot mise"
for tool in $MAC_TOOLS; do
    if ! brew list "$tool" >/dev/null 2>&1; then
        log "Installing $tool..."
        brew install "$tool"
    else
        echo "‚è≠Ô∏è  $tool already installed, skipping..."
    fi
done

# Ensure brew environment is active for the rest of the script
eval "$(/opt/homebrew/bin/brew shellenv)"
{{ end -}}

# ==============================================================================
#                               LINUX INSTALLATION (UNTOUCHED)
# ==============================================================================
{{ if eq .chezmoi.os "linux" -}}

# ---------- 1. CORE SYSTEM & DESKTOP APPS ----------
log "Checking core applications and Docker..."
sudo -v

# Install VS Code if missing
if ! command_exists code; then
    log "Installing VS Code..."
    curl -p https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > microsoft.gpg
    sudo install -D -o root -g root -m 644 microsoft.gpg /etc/apt/keyrings/microsoft.gpg
    echo "deb [arch=amd64,arm64,armhf signed-by=/etc/apt/keyrings/microsoft.gpg] https://packages.microsoft.com/repos/code stable main" | sudo tee /etc/apt/sources.list.d/vscode.list > /dev/null
    rm -f microsoft.gpg
    sudo apt-get update && sudo apt-get install -y code
fi

# Install Docker if missing
if ! command_exists docker; then
    log "Installing Docker..."
    sudo apt-get install -y ca-certificates curl gnupg
    sudo install -m 0755 -d /etc/apt/keyrings
    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
    sudo chmod a+r /etc/apt/keyrings/docker.gpg
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
    sudo apt-get update && sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
fi

# Install Mattermost Desktop
if ! command_exists mattermost-desktop; then
    log "Installing Mattermost Desktop..."
    curl -o- https://deb.packages.mattermost.com/setup-repo.sh | sudo bash
    sudo apt-get install -y mattermost-desktop
fi

# ---------- OS SPECIFIC PREPARATION ----------
export DEBIAN_FRONTEND=noninteractive

apt_installed() {
    dpkg -s "$1" >/dev/null 2>&1
}

log "Starting Linux system provisioning..."
sudo -v || { echo "‚ùå Sudo access required"; exit 1; }

REQUIRED_PKGS=(
    ca-certificates gnupg lsb-release software-properties-common
    curl wget git unzip build-essential zsh fzf jq htop tree tmux
    pkg-config libssl-dev libdbus-1-dev libncursesw5-dev
    libasound2-dev libpulse-dev libreadline-dev libsqlite3-dev
)

MISSING_PKGS=()
for pkg in "${REQUIRED_PKGS[@]}"; do
    apt_installed "$pkg" || MISSING_PKGS+=("$pkg")
done

if (( ${#MISSING_PKGS[@]} > 0 )); then
    log "Apt: Installing missing dependencies: ${MISSING_PKGS[*]}"
    sudo apt-get update -qq || warn "Apt update encountered warnings, continuing..."
    sudo apt-get install -y "${MISSING_PKGS[@]}" || sudo apt-get install -y libncurses-dev "${MISSING_PKGS[@]/libncursesw5-dev/}"
fi
{{ end -}}

# ==============================================================================
#                          SHARED TOOLING (MISE & CARGO)
# ==============================================================================

# 1. Mise Runtime Setup (Shared path logic)
if ! command_exists mise; then
    log "Installing mise..."
    curl https://mise.jdx.dev/install.sh | sh
fi
# Ensure mise is in PATH for the remainder of the script
{{ if eq .chezmoi.os "darwin" -}}
eval "$(/opt/homebrew/bin/brew shellenv)"
{{ end -}}


# Ensure mise and its installed tools are in PATH for the remainder of this script
export PATH="$HOME/.local/share/mise/bin:$HOME/.local/share/mise/shims:$PATH"

# Load mise environment into the current shell session
eval "$(mise activate bash --shims)"

log "Syncing Runtimes (Node & Python)..."
mise use --global node@latest
mise use --global python@latest

# Use 'mise exec' to bypass PATH issues during the install process
NODE_VER=$(mise exec node -- node -v)
# Python might be called 'python' or 'python3', we check both
PY_VER=$(mise exec python -- python --version 2>/dev/null || mise exec python -- python3 --version 2>/dev/null || echo "Unknown")

ok "Runtimes installed: $NODE_VER and $PY_VER"



# 2. Rust & Cargo
if ! command_exists cargo; then
    log "Installing Rust/Cargo..."
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    source "$HOME/.cargo/env"
fi

# 3. Cargo Tools Sync (Untouched logic)
log "Syncing Rust CLI tools..."

RUST_TOOLS="
ripgrep:rg
fd-find:fd
bat:bat
eza:eza
zoxide:zoxide
xh:xh
zellij:zellij
gitui:gitui
du-dust:dust
dua-cli:dua
starship:starship
hyperfine:hyperfine
bacon:bacon
fselect:fselect
git-delta:delta
ripgrep-all:rga
tokei:tokei
wiki-tui:wiki-tui
just:just
mask:mask
mprocs:mprocs
presenterm:presenterm
kondo:kondo
bob-nvim:bob
cargo-info:cargo-info
nu:nu
"

for entry in $RUST_TOOLS; do
    pkg="${entry%%:*}"
    bin="${entry##*:}"

    if command_exists "$bin"; then
        echo "‚è≠Ô∏è  $bin already installed, skipping..."
    else
        echo "‚åõ Installing $pkg..."
        cargo install "$pkg" --quiet || warn "Failed to install $pkg"
    fi
done




# ==============================================================================
#                          LINUX SPECIFIC POST-INSTALLS
# ==============================================================================
{{ if eq .chezmoi.os "linux" -}}
log "Starting Linux-specific post-installation tasks..."

# 1. Homebrew & Path Setup (Required for evil-helix)
if ! command_exists brew; then
    log "Homebrew not found. Installing Homebrew for Linux..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    
    # Dynamically add to current session path
    test -d ~/.linuxbrew && eval "$(~/.linuxbrew/bin/brew shellenv)"
    test -d /home/linuxbrew/.linuxbrew && eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
    ok "Homebrew installed and path configured."
else
    echo "‚è≠Ô∏è  Homebrew already installed, skipping..."
    # Ensure environment is loaded even if already installed
    test -d ~/.linuxbrew && eval "$(~/.linuxbrew/bin/brew shellenv)"
    test -d /home/linuxbrew/.linuxbrew && eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
fi

# 2. evil-helix (via Homebrew)
if ! command_exists hx; then
    log "Installing evil-helix..."
    brew install evil-helix && ok "evil-helix installed."
else
    # Check if the existing 'hx' is actually evil-helix or standard helix
    if hx --version | grep -iq "evil"; then
        echo "‚è≠Ô∏è  evil-helix already installed, skipping..."
    else
        warn "Standard Helix found, but you requested evil-helix. Skipping to avoid conflict."
    fi
fi

# 3. Fish Shell
if ! command_exists fish; then
    log "Installing Fish shell..."
    sudo apt install -y fish && ok "Fish installed."
else
    echo "‚è≠Ô∏è  Fish already installed, skipping..."
fi

# 4. Snap Packages (Yazi, ncspot, espanso)
# Helper for snap checks
install_snap() {
    local name=$1
    local classic=$2
    if ! snap list "$name" >/dev/null 2>&1; then
        log "Installing $name via Snap..."
        sudo snap install "$name" $classic && ok "$name installed."
    else
        echo "‚è≠Ô∏è  Snap: $name already installed, skipping..."
    fi
}

install_snap "yazi" "--classic"
install_snap "ncspot" ""
install_snap "espanso" "--classic"

# 5. rusty-man (Cargo)
if ! command_exists rusty-man; then
    log "Installing rusty-man via Cargo..."
    cargo install rusty-man --locked && ok "rusty-man installed."
else
    echo "‚è≠Ô∏è  rusty-man already installed, skipping..."
fi

# 6. Cursor AI (AppImage)
if ! command_exists cursor; then
    log "Installing Cursor AI..."
    mkdir -p "$HOME/.local/bin"
    # Ensure the directory is in the path for the symlink to be useful
    export PATH="$HOME/.local/bin:$PATH"
    
    if curl -L "https://downloader.cursor.sh/linux/appImage/x64" -o "$HOME/.local/bin/cursor.appimage"; then
        chmod +x "$HOME/.local/bin/cursor.appimage"
        ln -sf "$HOME/.local/bin/cursor.appimage" "$HOME/.local/bin/cursor"
        ok "Cursor AI installed to ~/.local/bin/cursor"
    else
        warn "Failed to download Cursor AI AppImage."
    fi
else
    echo "‚è≠Ô∏è  Cursor already installed, skipping..."
fi

echo -e "\nüéâ Linux Post-Install Complete!"
{{ end -}}


# ==============================================================================
#                          Provisioning Complete!
# ==============================================================================

echo -e "\n"
ok "Provisioning complete! Please restart your shell."
{{ end -}}
